# Data Model – Personal Music Streamer (PMS)

This document defines the **authoritative data models** used by the Personal Music Streamer backend.

The system intentionally avoids heavy databases in v1. All state is stored as **structured JSON on disk**, with Google Drive acting as the canonical media storage layer.

---

## 1. Design Principles

- **Explicit over implicit** – Every stored field has a clear purpose
- **Crash-safe** – State must survive restarts and power loss
- **Idempotent** – Re-running operations should not corrupt data
- **Derivable** – Media files live in Drive; metadata can be rebuilt if needed

---

## 2. Storage Locations

### 2.1 Local Disk (Host-Mounted Volume)

```
/data
├── state/
│   ├── library.json
│   ├── jobs.json
│   └── settings.json
├── temp/
│   └── downloads/
└── logs/
```

Local JSON files are the **source of truth for application state**.

---

## 3. Library Model

### 3.1 Overview

The library represents all successfully processed and uploaded tracks.

Each track:
- Corresponds to exactly **one Google Drive file**
- Is immutable after creation (except deletion)

---

### 3.2 library.json Structure

```json
{
  "version": 1,
  "updatedAt": "2026-01-01T12:00:00Z",
  "tracks": {
    "track_001": {
      "id": "track_001",
      "title": "Song Title",
      "artist": "Artist",
      "album": "Album",
      "duration": 245,
      "bitrate": 256,
      "format": "mp3",
      "source": {
        "url": "https://youtube.com/...",
        "platform": "youtube"
      },
      "drive": {
        "fileId": "1a2b3c",
        "folderId": "drive_folder_id",
        "path": "/Music/Albums/Album"
      },
      "artwork": {
        "embedded": true,
        "mimeType": "image/jpeg"
      },
      "createdAt": "2026-01-01T12:00:00Z"
    }
  }
}
```

---

### 3.3 Track ID Generation

- Generated by backend (`track_<timestamp>_<random>`)
- Never reused
- Used as primary key across API

---

## 4. Job Model

### 4.1 Overview

Jobs represent **long-running asynchronous operations**, primarily downloads.

Jobs are append-only and never silently removed.

---

### 4.2 jobs.json Structure

```json
{
  "version": 1,
  "updatedAt": "2026-01-01T12:00:00Z",
  "jobs": {
    "job_123": {
      "id": "job_123",
      "type": "download",
      "status": "queued | processing | completed | failed",
      "progress": 0.0,
      "source": {
        "url": "https://youtube.com/..."
      },
      "result": {
        "trackId": "track_001"
      },
      "error": null,
      "createdAt": "2026-01-01T12:00:00Z",
      "updatedAt": "2026-01-01T12:05:00Z"
    }
  }
}
```

---

### 4.3 Job State Transitions

```
queued → processing → completed
                   ↘ failed
```

Rules:
- Failed jobs are retryable
- Completed jobs are immutable

---

## 5. Google Drive Mapping

### 5.1 Role of Drive

Google Drive stores:
- Audio files (MP3)
- Optional artwork

Drive does **not** store:
- Job state
- Playback history
- Application logic

---

### 5.2 Drive File Mapping

Each track has a 1:1 mapping:

```
trackId → drive.fileId
```

This mapping is stored only in `library.json`.

---

### 5.3 Folder Strategy

```
Drive/Music/
├── Albums/
│   └── Album Name/
│       └── track.mp3
└── Singles/
    └── track.mp3
```

Folder paths are informational and may change without breaking playback.

---

## 6. Temp & Intermediate Files

### 6.1 Temp File Lifecycle

1. yt-dlp writes raw audio
2. FFmpeg produces normalized output
3. File uploaded to Drive
4. Temp files deleted

Temp files are **never referenced** by library metadata.

---

## 7. Settings Model

### 7.1 settings.json

```json
{
  "ownerEmail": "user@example.com",
  "audio": {
    "defaultFormat": "mp3",
    "defaultBitrate": 256
  },
  "jobs": {
    "concurrency": 1
  }
}
```

---

## 8. Consistency Guarantees

- Library entries are written **only after Drive upload success**
- Job completion implies library consistency
- Orphaned Drive files are safe but detectable

---

## 9. Recovery & Rebuild Strategy

If `library.json` is lost:
- Drive files remain intact
- Library can be rebuilt by scanning Drive folder
- Metadata may be partially recovered

If `jobs.json` is lost:
- No impact on playback
- Job history is lost only

---

## 10. Evolution Path

Future versions may replace JSON with:
- SQLite (drop-in)
- Indexed metadata
- Full-text search

These changes must preserve the existing data semantics.

---

## 11. Summary

The data model favors **clarity, durability, and recoverability** over flexibility. By keeping Drive as the canonical media store and local JSON as the operational state, the system remains easy to reason about, debug, and evolve.

